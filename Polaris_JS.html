<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
    on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Polaris - San Juan County WA</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dojox/grid/resources/Grid.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dojox/grid/resources/claroGrid.css">


    <style>
    .dojoxGrid table {
      margin: 0;
    }

    html, body {
      height:100%;
      width:100%;
      margin:0;
      padding:0;
    }
    #borderContainerTwo {
      width:100%;
      height:100%;
    }
    #map {
      height:100%;
      width:100%;
      overflow:hidden;
    }
    .layersDiv {
      background: #3d5d72;
    }
    #rightPane {
      width: 175px;
      margin: 0;
      padding: 0;
    }
    #paneHeader {
      background: url(images/header.png) repeat-x;
      color: white;
      border-bottom: solid 1px #B5BCC7;
      text-align: center;
      height: 30px;
      margin: 0;
      overflow: hidden;
      font-size: 16px;
      padding: 8px 5px;
    }
    .esriLegendServiceLabel {
      display:none;
    }

    </style>

    <script>var dojoConfig = {
      parseOnLoad: true,
      packages: [{
        "name":"agsjs",
        "location": "/GISApps/2.04/agsjs/src/agsjs"
      }]
    }
    </script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/"></script>
    <script>  

    dojo.require("esri.map");
    dojo.require("esri.arcgis.utils");
    dojo.require("esri.dijit.Popup");
    dojo.require("esri.dijit.BasemapGallery");
    dojo.require("esri.dijit.Legend");
    dojo.require("esri.dijit.OverviewMap");
    dojo.require("esri.layers.ArcGISDynamicMapServiceLayer");
    dojo.require("esri.tasks.find");
    dojo.require("dijit.layout.ContentPane");
    dojo.require("dijit.layout.BorderContainer");
    dojo.require("dijit.layout.AccordionContainer");
    dojo.require("dijit.layout.AccordionPane");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dijit.layout.LayoutContainer");
    dojo.require("dijit.form.Form");
    dojo.require("dijit.form.ValidationTextBox");
    dojo.require("dijit.form.Button");
    dojo.require("dojox.grid.DataGrid");
    dojo.require("dojo.data.ItemFileReadStore");
    dojo.require("agsjs.dijit.TOC");
    
    var map, initialExtent;
    var findTask, findParams;
    var findGraphicsLayer, hoverGraphicsLayer;

    function init() {
      dojo.connect(grid, "onRowClick", onRowClickHandler);
      var mapDeferred = esri.arcgis.utils.createMap("15f2060ce9cc476c8156c5be5bea4726", "map", {
        geometryServiceURL: "http://www.sjcgis.org/Polaris/rest/services/Geometry/GeometryServer"
      });
      mapDeferred.then(function(response) {
        console.log(response.itemInfo.item.title);
        map = response.map;
        var layers = response.itemInfo.itemData.operationalLayers;
        var layerInfo = dojo.map(layers, function(layer,index) {
          return {layer:layer.layerObject,title:layer.title};
        });

        initialExtent = map.extent;
        findGraphicsLayer = new esri.layers.GraphicsLayer();
        map.addLayer(findGraphicsLayer);
        
        findTask = new esri.tasks.FindTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer/");

        // Create find parameters
        findParams = new esri.tasks.FindParameters();
        findParams.returnGeometry = true;
        findParams.layerIds = [2,8,27];
        findParams.searchFields = ["PIN", "ADDRESS", "NAME"];
        findParams.outSpatialReference = map.spatialReference;

        dojo.connect(map,"onLayersAddResult",function(results){
          var toc = new agsjs.dijit.TOC({
            map: map,
            layerInfos: layerInfo
          }, "legendDiv");
          toc.startup();
        });

        var measurement = new esri.dijit.Measurement({
          map: map,
          defaultAreaUnit: esri.Units.SQUARE_MILES,
            defaultLengthUnit: esri.Units.MILES
        }, dojo.byId('measurementDiv'));
        
        var ovMapBaseLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://www.sjcgis.org/Polaris/rest/services/Island_Outlines/MapServer");

        var overviewMap = new esri.dijit.OverviewMap({
          map: map,
          height: 200,
          width: 200,
          baseLayer: ovMapBaseLayer,
        }, dojo.byId("overviewMapDiv"));
        overviewMap.startup();
      },function(error) {
          console.log("Map creation failed: ", error);
        });
      }

      function doSearch(searchText) {
        // Set search text to value in box
        findParams.searchText = searchText;
        findTask.execute(findParams,showResults);
      }

      function showResults(results) {
        //Show the results of FindTask using the FindResult returned by the doFind function
        findGraphicsLayer.clear(); //Clear existing graphics from map
        var polygonSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new
                                                             esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255,255,0]), 2),
                                                             new dojo.Color([255,255,0,0.25]));
        var lineSymbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,
                                                          new dojo.Color([98,194,204]),1);
        var markerSymbol = new esri.symbol.PictureMarkerSymbol({
          "url": "images/pin-red-28x28.png",
          "height": 20,
          "width": 20,
          "type": "picturemarkersymbol"
        });
        //Create array of result attributes and add graphics to map
        var items = dojo.map(results, function(result, id){
          var graphic = result.feature;
          var marker;
          switch (graphic.geometry.type) {
            case "point":
              graphic.setSymbol(markerSymbol);
              marker = new esri.Graphic(graphic.geometry, markerSymbol);
              break;
            case "polyline":
              graphic.setSymbol(lineSymbol);
              marker = new esri.Graphic(result.feature.geometry.getExtent().getCenter(), markerSymbol);
              break;
            case "polygon":
              graphic.setSymbol(polygonSymbol);
              marker = new esri.Graphic(result.feature.geometry.getExtent().getCenter(), markerSymbol);
              break;
          }
          findGraphicsLayer.add(marker);
          var attribs = result.feature.attributes;
          attribs.identifier = id;
          attribs.foundFieldName = result.foundFieldName;
          attribs.value = result.value;
          attribs.layerName = result.layerName;
          attribs.graphic = graphic;
          attribs.marker = marker;
          return attribs;
        });
        var data = {
          identifier: "identifier",
          items: items
        };
        var store = new dojo.data.ItemFileReadStore({
          data: data
        });
        grid.setStore(store);

        //Zoom back to initial map extent
        map.setExtent(initialExtent);
      }

      function clearSearch(){
        findGraphicsLayer.clear();
        dojo.byId('searchText').value = "";
        store = new dojo.data.ItemFileReadStore({data:{identifier:"", items:[]}});
        grid.setStore(store);
      }
        

      function onRowHoverHandler(evt){
        var hoverRowGraphic = grid.getItem(focus.rowIndex).graphic[0];
      }
      

      function onRowClickHandler(evt){
        findGraphicsLayer.clear();
        var clickedRowGraphic = grid.getItem(evt.rowIndex).graphic[0];
        findGraphicsLayer.add(clickedRowGraphic);
        if(clickedRowGraphic.geometry.type == "point") {
          map.centerAndZoom(clickedRowGraphic.geometry,8);
        } else {
          var screenPoint = clickedRowGraphic.geometry.getExtent().getCenter();
          map.centerAndZoom(screenPoint,8);
        }
      }
      dojo.ready(init);
    </script>
  </head>
  
  <body class="claro">
    <div id="borderContainerTwo" data-dojo-type="dijit.layout.BorderContainer"
         data-dojo-props="gutters:true, liveSplitters:false">
      <div id="topPane" data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'top', splitter:false">
        <h1>Polaris</h1>
      </div>
      <div id="map" data-dojo-type="dijit.layout.ContentPane"
           data-dojo-props="region:'center'">
      </div>
      <div data-dojo-type="dijit.layout.AccordionContainer"
           data-dojo-props="minSize:20, region:'leading', splitter:true"
           style="width:400px;" id="leftAccordion">
        <div data-dojo-type="dijit.layout.AccordionPane" title="Legend" selected="true">
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            <div id="legendDiv"></div>
          </div>
        </div>
        <div data-dojo-type="dijit.layout.AccordionPane" title="Search">
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            <div data-dojo-type="dijit.form.Form" id="searchForm" data-dojo-id="searchForm" action=""
                 method="">
              <label for="searchText">Enter an Address or Parcel Number to Search:</label>
              <input type="text" id="searchText" size=15 name="searchText" required="true"
                     data-dojo-type="dijit.form.ValidationTextBox" /><br />
              <button data-dojo-type="dijit.form.Button" type="button" name="searchButton" onClick="doSearch(dojo.byId('searchText').value);">Search</button>
              <button data-dojo-type="dijit.form.Button" type="button" name="clearButton"
                      onClick="clearSearch();">Clear</button>
            </div>
          </div>
          <table data-dojo-type="dojox.grid.DataGrid" jsid="grid" id="grid"
                 selectionMode="single" data-dojo-props="summary: 'Search Results:'">
            <thead>
              <tr>
                <th field="foundFieldName" width="100px">Type</th>
                <th field="value" width="200px">Value</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
      <div data-dojo-type="dijit.layout.AccordionPane" title="Saved Maps">
      </div>
    </div>
    </div>
  </body>
</html>
