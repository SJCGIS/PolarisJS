<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
    on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Identify with Popup</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">

    <style>
    html, body, #map {
      height:100%;
      width:100%;
      margin:0;
      padding:0;
    }
    </style>

    <script>var dojoConfig = { parseOnLoad: true }</script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/"></script>
    <script>  

    dojo.require("esri.map");
    dojo.require("esri.dijit.Popup");
    dojo.require("dijit.layout.ContentPane");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dijit.layout.LayoutContainer");
    dojo.require("dijit.form.Button");
    
    var map;
    var identifyTask, identifyParams;
    var queryTask, symbol, popup
    
    function init() {
      //set fillSymbol for identify and query tasks
      symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255,0,0]), 2), new dojo.Color([255,255,0,0.25]));

      var mapExtent = new esri.geometry.Extent(1053827.68909551,515293.874014814,1185179.1932883,666710.730399649,
                                               new esri.SpatialReference(2285));
      
      map = new esri.Map("map", {
        extent: mapExtent
      });

      dojo.connect(map, "onLoad", mapReady);
      
      var demLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://sjcgis.org/Polaris/rest/services/DEM/MapServer");
      var aerialsLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://sjcgis.org/Polaris/rest/services/New_Aerial1/MapServer");
      var mapContents = new esri.layers.ArcGISDynamicMapServiceLayer("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer");
      
      map.addLayers([aerialsLayer,demLayer,mapContents]);
    }
    
    function mapReady(map){
      dojo.connect(map,"onClick",executeIdentifyTask);

      //construct query task
      queryTask = new esri.tasks.QueryTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer/8");
      query = new esri.tasks.Query();
      query.returnGeometry = true;
      query.outFields = ["*"];

      //pass the URL parameters
      var urlObject = esri.urlToObject(document.location.href);
      if (urlObject.query) {
        P = urlObject.query.parcel;

        //construct the query based on the parameters
        var selection = "PIN = '" + P + "'";
        query.where = selection;
        
        //execute the query
        queryTask.execute(query,showResults);

      }

      //create identify tasks and setup parameters 
      identifyTask = new esri.tasks.IdentifyTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer");
      
      identifyParams = new esri.tasks.IdentifyParameters();
      identifyParams.tolerance = 3;
      identifyParams.returnGeometry = true;
      identifyParams.layerIds = [1,8,9];
      identifyParams.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;
      identifyParams.width  = map.width;
      identifyParams.height = map.height;

      map.infoWindow.resize(415,200);
      map.infoWindow.setContent(dijit.byId("tabs").domNode);
      map.infoWindow.setTitle("Identify Results");
    }

    function showResults(featureSet) {
      map.graphics.clear();
      map.infoWindow.hide();

      var resultFeatures = featureSet.features;

      for (var i=0, il=resultFeatures.length; i<il; i++) {
        var graphic = resultFeatures[i];
        graphic.setSymbol(symbol);
        map.graphics.add(graphic);
      }

      //zoom to extent of the graphics
      var myFeatureExtent = esri.graphicsExtent(resultFeatures);
      map.setExtent(myFeatureExtent);
    }
    
    function executeIdentifyTask(evt) {
      map.graphics.clear();
      identifyParams.geometry = evt.mapPoint;
      identifyParams.mapExtent = map.extent;
      identifyTask.execute(identifyParams, function(idResults){addToMap(idResults,evt);});
    }

    function addToMap(idResults,evt) {
      bldgResults = {displayFieldName:null,features:[]};
      taxParcelResults = {displayFieldName:null,features:[]};
      legalParcelResults = {displayFieldName:null,features:[]};

      for (var i=0, il=idResults.length; i<il; i++) {
        var idResult = idResults[i];
        if (idResult.layerId === 1) {
          bldgResults.features.push(idResult.feature);
        }
        else if (idResult.layerId === 8) {
          legalParcelResults.features.push(idResult.feature);
        }
        else if (idResult.layerId === 9) {
          taxParcelResults.features.push(idResult.feature);
        }
      }
      dijit.byId("bldgTab").setContent(layerTabContent(bldgResults,"bldgResults"));
      dijit.byId("taxParcelTab").setContent(layerTabContent(taxParcelResults,"taxParcelResults"));
      dijit.byId("legalParcelTab").setContent(layerTabContent(legalParcelResults,"legalParcelResults"));

      map.infoWindow.show(evt.screenPoint, map.getInfoWindowAnchor(evt.screenPoint));
    }

    function layerTabContent(layerResults, layerName) {
      var content = "";
      switch (layerName) {
        case "bldgResults":
          content = "<table border='1'><tr><th>Building Type</th><th>Address</th></tr>";
          for (var i=0, il=layerResults.features.length; i<il; i++) {
            content += "<tr><td>" + layerResults.features[i].attributes['Building Type'] + "</td>";
            content += "<td>" + layerResults.features[i].attributes['Address'] + "</td></tr>";
        }
        content += "</table>";
        break;

        case "taxParcelResults":
        content = "<table border='1'><tr><th>Parcel Number</th><th>Owner</th></tr>";
        for (var i=0, il=layerResults.features.length; i<il; i++) {
          content += "<tr><td>" + layerResults.features[i].attributes['Tax Parcel Number'] + "</td>";
          content += "<td>" + layerResults.features[i].attributes['Owner'] + "</td></tr>";
        }
        content += "</table>";
        break;

        case "legalParcelResults":
        content = "<table border='1'><tr><th>Parcel Number</th><th>Owner</th></tr>";
        for (var i=0, il=layerResults.features.length; i<il; i++) {
          content += "<tr><td>" + layerResults.features[i].attributes['Parcel Number'] + "</td>";
          content += "<td>" + layerResults.features[i].attributes['Owner'] + "</td></tr>";
        }
        content += "</table>";
        break;
      }
      return content;
    }
    /* template.content += "<h4>Available Links</h4>";
    template.content += "<a target=_blank href=http://sanjuanco.com/auditor/RecordSearch.aspx?pno=${Parcel Number}>View Recorded Documents</a><br>";
    template.content += "<a target=_blank href=http://sanjuanco.com/assessor/parcelinfo.aspx?prop=${TA_ID}>View Assessor Information</a><br>";
    template.content += "<a target=_blank href=http://parcel.sanjuanco.com/PropertyAccess/Property.aspx?year=2013&prop_id=${TA_ID}>View Property Tax Statements</a><br>"; */
      
    /* // InfoWindow expects an array of features from each deferred
    // object that you pass. If the response from the task execution 
    // above is not an array of features, then you need to add a callback
    // like the one above to post-process the response and return an
    // array of features.
    map.graphics.clear();
    map.infoWindow.setFeatures([ deferred ]);
    map.infoWindow.show(evt.mapPoint);
    } */
    
    dojo.ready(init);
    </script>
  </head>
  
  <body class="claro">
    <div id="map"></div>
    <div id="tabs" dojoType="dijit.layout.TabContainer" style="width:385px;height:180px;">
      <div id="bldgTab" dojoType="dijit.layout.ContentPane" title="Buildings"></div>
      <div id="taxParcelTab" dojoType="dijit.layout.ContentPane" title="Tax Parcels"></div>
      <div id="legalParcelTab" dojoType="dijit.layout.ContentPane" title="Legal Parcels"></div>
    </div>body>
  </
body>
</html>
