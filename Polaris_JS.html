<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
    on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Cassiopeia - San Juan County WA</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">

    <style>
    html, body {
      height:100%;
      width:100%;
      margin:0;
      padding:0;
    }
    #borderContainerTwo {
      width:100%;
      height:100%;
    }
    #map {
      height:100%;
      width:100%;
      overflow:hidden;
    }
    #rightPane {
      width: 175px;
      margin: 0;
      padding: 0;
    }
    #paneHeader {
      background: url(images/header.png) repeat-x;
      color: white;
      border-bottom: solid 1px #B5BCC7;
      text-align: center;
      height: 30px;
      margin: 0;
      overflow: hidden;
      font-size: 16px;
      padding: 8px 5px;
    }
    .esriLegendServiceLabel {
      display:none;
      }

    </style>

    <script>var dojoConfig = { parseOnLoad: true }</script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/"></script>
    <script>  

    dojo.require("esri.map");
    dojo.require("esri.dijit.Popup");
    dojo.require("esri.dijit.BasemapGallery");
    dojo.require("esri.dijit.Legend");
    dojo.require("dijit.layout.ContentPane");
    dojo.require("dijit.layout.BorderContainer");
    dojo.require("dijit.layout.AccordionContainer");
    dojo.require("dijit.layout.AccordionPane");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dijit.layout.LayoutContainer");
    dojo.require("dijit.form.Button");
    
    var map;
    var identifyTask, identifyParams;
    var queryTask, symbol, popup
    
    function init() {
      //set fillSymbol for identify and query tasks
      symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255,0,0]), 2), new dojo.Color([255,255,0,0.25]));

      var mapExtent = new esri.geometry.Extent(1053827.68909551,515293.874014814,1185179.1932883,666710.730399649,
                                               new esri.SpatialReference(2285));
      
      map = new esri.Map("map", {
        extent: mapExtent
      });

      createBasemapGallery();

      dojo.connect(map, "onLoad", mapReady);
    }

    function createBasemapGallery() {
      //manually create basemaps to add to basemap gallery
      var basemaps = [];

      var featureLabels = new esri.dijit.BasemapLayer({
        url: "http://www.sjcgis.org/Polaris/rest/services/Feature_Labels/MapServer",
        isReference: true
      });

      var aerial = new esri.dijit.BasemapLayer({
        url: "http://www.sjcgis.org/Polaris/rest/services/New_Aerial1/MapServer"
      });

      var dem = new esri.dijit.BasemapLayer({
        url: "http://www.sjcgis.org/Polaris/rest/services/DEM/MapServer"
      });

      var aerialBasemap = new esri.dijit.Basemap({
        layers:[dem,featureLabels,aerial],
        title: "DEM/Aerial",
        thumbnailUrl:"images/waterThumb.png"
      });

      basemaps.push(aerialBasemap);

      var bareEarth = new esri.dijit.BasemapLayer({
        url: "http://www.sjcgis.org/Polaris/rest/services/Bare_Earth/MapServer",
        opacity: 0.40
      });

      var shoreLines = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Shore2/MapServer"
      });

      var contours = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers:[6,44]
      });

      var slopeLayer = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers:[45,46,47]
      });

      var slopeGeoHazard = new esri.dijit.Basemap({
        layers      :[bareEarth,slopeLayer,contours,shoreLines,featureLabels],
        title       :"GeoHazards-Slopes",
        thumbnailUrl:"images/waterThumb.png"
      });
      basemaps.push(slopeGeoHazard);

      var erosionLayer = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers:[48]
      });

      var erosionGeoHazard = new esri.dijit.Basemap({
        layers: [bareEarth,erosionLayer,contours,shoreLines,featureLabels],
        title: "GeoHazards-Erosion",
        thumbnailUrl:"images/waterThumb.png"
      });
      basemaps.push(erosionGeoHazard);

      var comprehensivePlanLayer = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers:[53,54]
      });

      var comprehensivePlanBasemap = new esri.dijit.Basemap({
        layers: [bareEarth,comprehensivePlanLayer,shoreLines,featureLabels],
        title: "Comprehensive Plan",
        thumbnailUrl:"images/waterThumb.png"
      });
      basemaps.push(comprehensivePlanBasemap);

      var wetlandsPossible = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers: [38,39]
      });

      var wetlandsPossibleBasemap = new esri.dijit.Basemap({
        layers: [bareEarth, wetlandsPossible,contours,shoreLines,featureLabels],
        title: "Possible Wetlands",
        thumbnailUrl:"images/waterThumb.png"
      });
      basemaps.push(wetlandsPossibleBasemap);
      
      var wetlandsOld = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers: [42]
      });

      var wetlandsOldBasemap = new esri.dijit.Basemap({
        layers      :[bareEarth,wetlandsOld,contours,shoreLines,featureLabels],
        title       :"Wetlands (Before 2010)",
        thumbnailUrl:"images/safetyThumb.png"
      });
      basemaps.push(wetlandsOldBasemap);

      var uplandHabitat = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers: [30]
      });

      var uplandHabitatBasemap = new esri.dijit.Basemap({
        layers:[bareEarth,uplandHabitat,contours,shoreLines,featureLabels],
        title: "Upland Habitats",
        thumbnailUrl:"images/safetyThumb.png"
      });
      basemaps.push(uplandHabitatBasemap);

      var floodZones = new esri.dijit.BasemapLayer({
        url:"http://www.sjcgis.org/Polaris/rest/services/Map_Contents/MapServer",
        visibleLayers: [40,41]
      });

      var floodZonesBasemap = new esri.dijit.Basemap({
        layers:[bareEarth,floodZones,contours,shoreLines,featureLabels],
        title: "Flood Zones",
        thumbnailUrl:"images/safetyThumb.png"
      });
      basemaps.push(floodZonesBasemap);

      var basemapGallery = new esri.dijit.BasemapGallery({
        showArcGISBasemaps:false,
        basemaps          :basemaps,
        map               :map
      }, "basemapGallery");
      
      var selectionHandler = dojo.connect(basemapGallery, "onSelectionChange", function(){
        dojo.disconnect(selectionHandler);
        
        // add the map contents to the map        
        var mapContents = new esri.layers.ArcGISDynamicMapServiceLayer("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer");
        mapContents.setVisibleLayers([2,3,4,5,8,9,12,13,15,16,18,19,26,27,28,29]);
        map.addLayer(mapContents);

        console.log(basemapGallery.getSelected());

        var legend = new esri.dijit.Legend({
          map:map,
          layerInfos: [{layer:mapContents,hideLayers:[0,7,10,35,43]}]
          }, "legend");
        legend.startup();
      });
      
      
      basemapGallery.startup();

      dojo.connect(basemapGallery, "onError", function (error) {
        console.log(error)
      });
    }
    
    function mapReady(map){
      dojo.connect(map,"onClick",executeIdentifyTask);

      //construct query task
      queryTask = new esri.tasks.QueryTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer/8");
      query = new esri.tasks.Query();
      query.returnGeometry = true;
      query.outFields = ["*"];

      //pass the URL parameters
      var urlObject = esri.urlToObject(document.location.href);
      if (urlObject.query) {
        P = urlObject.query.parcel;

        //construct the query based on the parameters
        var selection = "PIN = '" + P + "'";
        query.where = selection;
        
        //execute the query
        queryTask.execute(query,showResults);

      }

      //create identify tasks and setup parameters 
      identifyTask = new esri.tasks.IdentifyTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer");
      
      identifyParams = new esri.tasks.IdentifyParameters();
      identifyParams.tolerance = 3;
      identifyParams.returnGeometry = true;
      identifyParams.layerIds = [1,8,9];
      identifyParams.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;
      identifyParams.width  = map.width;
      identifyParams.height = map.height;

      map.infoWindow.resize(415,200);
      map.infoWindow.setContent(dijit.byId("tabs").domNode);
      map.infoWindow.setTitle("Identify Results");
    }

    function showResults(featureSet) {
      map.graphics.clear();
      map.infoWindow.hide();

      var resultFeatures = featureSet.features;

      for (var i=0, il=resultFeatures.length; i<il; i++) {
        var graphic = resultFeatures[i];
        graphic.setSymbol(symbol);
        map.graphics.add(graphic);
      }

      //zoom to extent of the graphics
      var myFeatureExtent = esri.graphicsExtent(resultFeatures);
      map.setExtent(myFeatureExtent);
    }
    
    function executeIdentifyTask(evt) {
      map.graphics.clear();
      identifyParams.geometry = evt.mapPoint;
      identifyParams.mapExtent = map.extent;
      identifyTask.execute(identifyParams, function(idResults){addToMap(idResults,evt);});
    }

    function addToMap(idResults,evt) {
      bldgResults = {displayFieldName:null,features:[]};
      taxParcelResults = {displayFieldName:null,features:[]};
      legalParcelResults = {displayFieldName:null,features:[]};

      for (var i=0, il=idResults.length; i<il; i++) {
        var idResult = idResults[i];
        if (idResult.layerId === 1) {
          bldgResults.features.push(idResult.feature);
        }
        else if (idResult.layerId === 8) {
          legalParcelResults.features.push(idResult.feature);
        }
        else if (idResult.layerId === 9) {
          taxParcelResults.features.push(idResult.feature);
        }
      }
      dijit.byId("bldgTab").setContent(layerTabContent(bldgResults,"bldgResults"));
      dijit.byId("taxParcelTab").setContent(layerTabContent(taxParcelResults,"taxParcelResults"));
      dijit.byId("legalParcelTab").setContent(layerTabContent(legalParcelResults,"legalParcelResults"));

      map.infoWindow.show(evt.screenPoint, map.getInfoWindowAnchor(evt.screenPoint));
    }

    function layerTabContent(layerResults, layerName) {
      var content = "";
      switch (layerName) {
        case "bldgResults":
          content = "<table border='1'><tr><th>Building Type</th><th>Address</th></tr>";
          for (var i=0, il=layerResults.features.length; i<il; i++) {
            content += "<tr><td>" + layerResults.features[i].attributes['Building Type'] + "</td>";
            content += "<td>" + layerResults.features[i].attributes['Address'] + "</td></tr>";
        }
        content += "</table>";
        break;

        case "taxParcelResults":
        content = "<table border='1'><tr><th>Parcel Number</th><th>Owner</th></tr>";
        for (var i=0, il=layerResults.features.length; i<il; i++) {
          content += "<tr><td>" + layerResults.features[i].attributes['Tax Parcel Number'] + "</td>";
          content += "<td>" + layerResults.features[i].attributes['Owner'] + "</td></tr>";
        }
        content += "</table>";
        break;

        case "legalParcelResults":
        content = "<table border='1'><tr><th>Parcel Number</th><th>Owner</th></tr>";
        for (var i=0, il=layerResults.features.length; i<il; i++) {
          content += "<tr><td>" + layerResults.features[i].attributes['Parcel Number'] + "</td>";
          content += "<td>" + layerResults.features[i].attributes['Owner'] + "</td></tr>";
        }
        content += "</table>";
        break;
      }
      return content;
    }
    /* template.content += "<h4>Available Links</h4>";
    template.content += "<a target=_blank href=http://sanjuanco.com/auditor/RecordSearch.aspx?pno=${Parcel Number}>View Recorded Documents</a><br>";
    template.content += "<a target=_blank href=http://sanjuanco.com/assessor/parcelinfo.aspx?prop=${TA_ID}>View Assessor Information</a><br>";
    template.content += "<a target=_blank href=http://parcel.sanjuanco.com/PropertyAccess/Property.aspx?year=2013&prop_id=${TA_ID}>View Property Tax Statements</a><br>"; */
    
    /* // InfoWindow expects an array of features from each deferred
    // object that you pass. If the response from the task execution 
    // above is not an array of features, then you need to add a callback
    // like the one above to post-process the response and return an
    // array of features.
    map.graphics.clear();
    map.infoWindow.setFeatures([ deferred ]);
    map.infoWindow.show(evt.mapPoint);
    } */
    
    dojo.ready(init);
    </script>
  </head>
  
  <body class="claro">
    <div id="borderContainerTwo" data-dojo-type="dijit.layout.BorderContainer"
         data-dojo-props="gutters:true, liveSplitters:false">
      <div id="topPane" data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'top', splitter:false">
        <h1>Cassiopeia</h1>
      </div>
      <div id="map" data-dojo-type="dijit.layout.ContentPane"
           data-dojo-props="region:'center'">
        <!-- <div id="tabs" data-dojo-type="dijit.layout.TabContainer" style="width:385px;height:180px;">
        <div id="bldgTab" data-dojo-type="dijit.layout.ContentPane" title="Buildings"></div>
        <div id="taxParcelTab" data-dojo-type="dijit.layout.ContentPane" title="Tax Parcels"></div>
        <div id="legalParcelTab" data-dojo-type="dijit.layout.ContentPane" title="Legal Parcels"></div>
        </div> -->
      </div>
      <div data-dojo-type="dijit.layout.AccordionContainer"
           data-dojo-props="minSize:20, region:'leading', splitter:true"
           style="width:400px;" id="leftAccordion">
        <div data-dojo-type="dijit.layout.AccordionPane" title="Legend" selected="true">
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            <div id="legend"></div>
          </div>
        </div>
        <div data-dojo-type="dijit.layout.AccordionPane" title="Overview Map">
        </div>
        <div data-dojo-type="dijit.layout.AccordionPane" title="Saved Maps">
        </div>
      </div>
      <div id="rightPane" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'right'">
        <div data-dojo-type="dijit.layout.BorderContainer"
             data-dojo.props="design:'headline', gutters:false"
             style="width:100%;height:100%;">
          <div id="paneHeader" data-dojo-type="dijit.layout.ContentPane"
          data-dojo-props="region:'top'">
            <span>Select Basemap</span>
          </div>
          <div data-dojo-type="dijit.layout.ContentPane"
               data-dojo-props="region:'center'">
            <div id="basemapGallery"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
