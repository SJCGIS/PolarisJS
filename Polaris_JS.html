<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
    on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Polaris - San Juan County WA</title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dojox/grid/resources/Grid.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dojox/grid/resources/claroGrid.css">


    <style>
    .dojoxGrid table {
      margin: 0;
    }

    html, body {
      height:100%;
      width:100%;
      margin:0;
      padding:0;
    }
    #borderContainerTwo {
      width:100%;
      height:100%;
    }
    #map {
      height:100%;
      width:100%;
      overflow:hidden;
    }
    .layersDiv {
      background: #3d5d72;
    }
    #rightPane {
      width: 175px;
      margin: 0;
      padding: 0;
    }
    #paneHeader {
      background: url(images/header.png) repeat-x;
      color: white;
      border-bottom: solid 1px #B5BCC7;
      text-align: center;
      height: 30px;
      margin: 0;
      overflow: hidden;
      font-size: 16px;
      padding: 8px 5px;
    }
    .esriLegendServiceLabel {
      display:none;
    }

    </style>

    <script>var dojoConfig = {
      parseOnLoad: true,
      packages: [{
        "name":"agsjs",
        "location": "/GISApps/2.04/agsjs/src/agsjs"
      }]
    }
    </script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/"></script>
    <script>  

    dojo.require("esri.map");
    dojo.require("esri.arcgis.utils");
    dojo.require("esri.dijit.Popup");
    dojo.require("esri.dijit.BasemapGallery");
    dojo.require("esri.dijit.Legend");
    dojo.require("esri.dijit.OverviewMap");
    dojo.require("esri.layers.ArcGISDynamicMapServiceLayer");
    dojo.require("esri.tasks.find");
    dojo.require("dijit.layout.ContentPane");
    dojo.require("dijit.layout.BorderContainer");
    dojo.require("dijit.layout.AccordionContainer");
    dojo.require("dijit.layout.AccordionPane");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dijit.layout.LayoutContainer");
    dojo.require("dijit.form.Button");
    dojo.require("dojox.grid.DataGrid");
    dojo.require("dojo.data.ItemFileReadStore");
    dojo.require("agsjs.dijit.TOC");
    
    var map;
    var findTask, findParams;

    function init() {
      var mapDeferred = esri.arcgis.utils.createMap("15f2060ce9cc476c8156c5be5bea4726", "map", {
        geometryServiceURL: "http://www.sjcgis.org/Polaris/rest/services/Geometry/GeometryServer"
      });
      mapDeferred.then(function(response) {
        console.log(response.itemInfo.item.title);
        map = response.map;
        var layers = response.itemInfo.itemData.operationalLayers;
        var layerInfo = dojo.map(layers, function(layer,index) {
          return {layer:layer.layerObject,title:layer.title};
        });

        findTask = new esri.tasks.FindTask("http://sjcgis.org/Polaris/rest/services/Map_Contents/MapServer/");

        // Create find parameters
        findParams = new esri.tasks.FindParameters();
        findParams.returnGeometry = true;
        findParams.layerIds = [2,8,27];
        findParams.searchFields = ["PIN", "ADDRESS", "NAME"];
        findParams.outSpatialReference = map.spatialReference;
        
        dojo.connect(map,"onLayersAddResult",function(results){
          var toc = new agsjs.dijit.TOC({
            map: map,
            layerInfos: layerInfo
          }, "legendDiv");
          toc.startup();
        });
        
        var ovMapBaseLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://www.sjcgis.org/Polaris/rest/services/Island_Outlines/MapServer");

        var overviewMap = new esri.dijit.OverviewMap({
          map: map,
          height: 200,
          width: 200,
          baseLayer: ovMapBaseLayer,
        }, dojo.byId("overviewMapDiv"));
        overviewMap.startup();
      },function(error) {
          console.log("Map creation failed: ", error);
        });
      }

      function doSearch(searchText) {
        // Set search text to value in box
        findParams.searchText = searchText;
        findTask.execute(findParams,showResults);
      }

      function showResults(results) {
        //Show the results of FindTask using the FindResult returned by the doFind function
        map.graphics.clear(); //Clear existing graphics from map
        var polygonSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new
                                                             esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([98,194,204]), 2),
                                                             new dojo.Color([98,194,204,0.5]));
        var lineSymbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,
                                                          new dojo.Color([98,194,204]),1);
        var markerSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new
                                                              esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([98,194,204]),1),
                                                              new dojo.Color([0,255,0,0.25]));
        //Create array of result attributes and add graphics to map
        var dataForGrid  = [];
        dojo.forEach(results, function(result, id){
          console.log(result.value, "at index", id);
          var graphic = result.feature;
          dataForGrid.push([result.foundFieldName, result.value]);
          switch (graphic.geometry.type) {
            case "point":
              graphic.setSymbol(markerSymbol);
              break;
            case "polyline":
              graphic.setSymbol(lineSymbol);
              break;
            case "polygon":
              graphic.setSymbol(polygonSymbol);
              break;
          }
          map.graphics.add(graphic);
        });
        var data = {
          items: dataForGrid
        };
        var store = new dojo.data.ItemFileReadStore({
          data: data
        });
        grid.setStore(store);
      }
        
      dojo.ready(init);
    </script>
  </head>
  
  <body class="claro">
    <div id="borderContainerTwo" data-dojo-type="dijit.layout.BorderContainer"
         data-dojo-props="gutters:true, liveSplitters:false">
      <div id="topPane" data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'top', splitter:false">
        <h1>Polaris</h1>
      </div>
      <div id="map" data-dojo-type="dijit.layout.ContentPane"
           data-dojo-props="region:'center'">
      </div>
      <div data-dojo-type="dijit.layout.AccordionContainer"
           data-dojo-props="minSize:20, region:'leading', splitter:true"
           style="width:400px;" id="leftAccordion">
        <div data-dojo-type="dijit.layout.AccordionPane" title="Legend" selected="true">
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            <div id="legendDiv"></div>
          </div>
        </div>
        <div data-dojo-type="dijit.layout.AccordionPane" title="Search">
          <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            Enter an Address or Parcel Number to Search:
            <input type="text" id="searchText" value="350 Court St" />
            <input type="button" value="Search" onclick="doSearch(dojo.byId('searchText').value);" />
          </div>
          <table data-dojo-type="dojox.grid.DataGrid" jsid="grid" id="grid">
            <thead>
              <tr>
                <th field="0">Layer</th>
                <th field="1">Value</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
      <div data-dojo-type="dijit.layout.AccordionPane" title="Saved Maps">
      </div>
    </div>
    </div>
  </body>
</html>
